FROM 003-casarest:latest as buildenv

RUN apt-get update --fix-missing
RUN apt-get remove -y cmake
RUN wget https://github.com/Kitware/CMake/releases/download/v3.20.3/cmake-3.20.3-linux-x86_64.tar.gz -P /home/yanda/cmake-build/cmake
RUN tar -xvf /home/yanda/cmake-build/cmake/cmake-3.20.3-linux-x86_64.tar.gz -C /home/yanda/cmake-build/cmake

RUN apt-get install -y linux-tools-common linux-tools-generic vim valgrind tmux

ENV PATH "$PATH:/home/yanda/yandasoft/build/apps"
ENV PATH "$PATH:/home/yanda/cmake-build/cmake/cmake-3.20.3-linux-x86_64/bin/"
ENV CASACORE_SW_DIR "/usr/local/share/casacore"

RUN mkdir -p /home/user && touch /home/user/.casarc
# RUN apt-get install -y libgomp1-dbg

RUN echo "measures.DE200.directory: ${CASACORE_SW_DIR}/data/ephemerides" >> /home/user/.casarc && \
echo "measures.DE405.directory: ${CASACORE_SW_DIR}/data/ephemerides" >> /home/user/.casarc && \
echo "measures.line.directory: ${CASACORE_SW_DIR}/data/ephemerides" >> /home/user/.casarc && \
echo "measures.sources.directory: ${CASACORE_SW_DIR}/data/ephemerides" >> /home/user/.casarc && \
echo "measures.comet.directory: ${CASACORE_SW_DIR}/data/ephemerides" >> /home/user/.casarc && \
echo "measures.ierseop97.directory: ${CASACORE_SW_DIR}/data/geodetic" >> /home/user/.casarc && \
echo "measures.ierspredict.directory: ${CASACORE_SW_DIR}/data/geodetic" >> /home/user/.casarc && \
echo "measures.tai_utc.directory: ${CASACORE_SW_DIR}/data/geodetic" >> /home/user/.casarc && \
echo "measures.igrf.directory: ${CASACORE_SW_DIR}/data/geodetic" >> /home/user/.casarc && \
echo "measures.observatory.directory: ${CASACORE_SW_DIR}/data/geodetic" >> /home/user/.casarc

RUN git clone https://github.com/brendangregg/FlameGraph.git /home/yanda/flamegraph
ENV PATH "$PATH:/home/yanda/flamegraph"

ifdef(`LINUX',
ARG USER_ID
ARG GROUP_ID

RUN addgroup --gid $GROUP_ID yanda
RUN adduser --disabled-password --gecos '' --uid $USER_ID --gid $GROUP_ID yanda

RUN chown -R yanda:yanda /home/yanda
USER yanda
, )

WORKDIR /home/yanda
